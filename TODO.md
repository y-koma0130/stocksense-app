# TODO

## Phase 1: 法的整備 + フィードバック基盤 ✅ 完了

### 法的ページの作成
- [x] LP (ランディングページ) の作成
- [x] 利用規約ページの作成
- [x] プライバシーポリシーページの作成
- [ ] お問い合わせページの作成 (スキップ)

### フッターの実装
- [x] フッターコンポーネントの作成
- [x] 法的ページへのリンク配置
- [x] レスポンシブ対応

### ユーザーフィードバック機能
- [x] GitHub Issues自動登録機能の実装
- [x] フィードバック送信UIの作成 (アカウントメニューに統合)
- [x] フィードバック送信APIの実装 (GitHub API連携)
- [x] フィードバック種別の追加 (バグ報告、機能リクエスト、UI改善、その他)

---

## Phase 2: 無料β版ユーザー獲得準備 ✅ 完了

### スコアリングロジックのリファクタリング ✅ 完了
- [x] 定数の集約 (marketTypes, periodTypes)
- [x] 値オブジェクトの整理 (indicatorScore, totalScore)
- [x] 集約エンティティの作成 (valueStockScore)
- [x] ドメインサービスの分割 (各スコア計算関数を個別ファイル化)
- [x] ユーティリティの共通化 (clamp関数)
- [x] 冗長なラッパーサービスの削除
- [x] ユースケースのリファクタリング
- [x] sector_averagesの最新データを使用するようJOIN条件を修正
- [x] スコアリングロジックの修正（0-100の範囲で適切にスコアが分散）

### UI/UXのモバイル対応 ✅ 完了
- [x] ヘッダーのレスポンシブ対応
  - [x] モバイルでロゴをアイコンのみに切り替え
  - [x] 通知設定ボタンのサイズ調整
  - [x] スクロール時にヘッダーを自動非表示/表示
- [x] ドロワーのモバイル対応 (モバイルで100%幅表示)
- [x] ダッシュボードのレスポンシブ対応
- [x] マーケットサマリーのモバイル表示最適化
- [x] バリュー株ランキングのモバイル表示最適化
- [x] フッターのモバイル対応確認

### 通知メッセージの改善 ✅ 完了
- [x] LINE通知メッセージのフォーマット改善
  - [x] スコアを0-100に統一
  - [x] 上位3銘柄に詳細情報（PER/PBR業種比、RSI状態、価格位置）を追加
  - [x] 4位以降は簡略表示
  - [x] メダル絵文字で視覚的に改善
- [x] 銘柄情報の見やすさ向上
- [x] スコア表示の視覚的改善
- [x] ウェブ画面での銘柄名にYahoo Financeへの外部リンクを追加
- [x] デフォルト表示を中期（短期）に変更
- [x] ドロワー内の価格位置表示を期間に応じて動的に切り替え（26週/52週）

### LLM個別株分析の実装 ✅ 完了
- [x] OpenAI Responses APIとWeb検索の統合
- [x] StockAnalysisテーブルの設計と実装
- [x] 週次個別株分析ジョブの実装（中期目線・上位5銘柄）
- [x] 月次個別株分析ジョブの実装（長期目線・上位5銘柄）
- [x] AI分析結果の表示UI実装
  - [x] バリュー株評価（5段階）の表示
  - [x] 総合評価コメントの表示
  - [x] 投資魅力ポイントの表示
  - [x] 注意すべきリスクの表示
  - [x] AI生成物であることの免責事項表示
- [x] 評価ラベルのユーザーフレンドリー化（超おすすめ、おすすめ、中立、注意、要注意）
- [x] カラーテーマの統一（統一された5段階評価カラーパレット）
- [x] テーブルでのAI解析状況表示
- [x] Lintエラーの修正

### マーケティング準備 ✅ 完了
- [x] X (Twitter) 投稿用のスクリーンショット準備
- [x] プロモーション文言の作成
- [x] β版ユーザー募集開始

---

## Phase 2.5: UI改善 & 基盤整備 (現在進行中)

### UI/UX改善 ✅ 完了
- [x] 指標説明用ツールチップの追加
  - [x] PER, PBR, RSI, 価格位置の説明
  - [x] 各指標の「良い値」「悪い値」の目安表示
- [x] ローディング状態の改善
  - [x] スケルトンスクリーンの実装（サマリーカード、テーブル、通知ドロワー、銘柄詳細ドロワー）
- [x] スコアリング説明バナーの追加
  - [x] 折りたたみ式の説明バナー
  - [x] 罠銘柄除外条件の説明（自己資本比率、営業利益減少、営業CF）
- [x] ヒーローセクションの改善
  - [x] ロゴ画像への切り替え
- [x] LPの改善
  - [x] サービス画像の追加
  - [x] AI機能の説明追加
- [x] Hydrationエラーの修正
  - [x] Tooltipコンポーネントのbutton→span変更（ボタンネスト回避）
  - [x] StockAnalysisSectionの「もっと読む」ボタン修正

### ユーザー権限・プラン基盤の整備 ✅ 完了
- [x] `user_subscriptions` テーブルの設計と実装
- [x] プラン型定義 (free/standard/pro)
- [x] DDD構造でのサブスクリプション機能実装
  - [x] エンティティ (userSubscription)
  - [x] クエリサービス (getUserSubscriptionByUserId)
  - [x] リポジトリ (insertUserSubscription)
  - [x] ユースケース (initializeUserSubscription)
  - [x] tRPCルーター (userSubscriptionRouter)
- [x] ログイン時のサブスクリプション自動初期化 (冪等処理)
- [x] 認証コールバックのリファクタリング (useAuthCallbackフック)
- [x] 使用制限チェック機能 (LINE分析回数制限)
- [ ] プラン別機能制限の定義 (課金実装時)

### スコアリング・除外ロジックの改善
- [x] Vitestによるスコアリングロジックのユニットテスト整備
  - [x] calculatePERScore テスト
  - [x] calculateRSIScore テスト
  - [x] calculatePriceRangeScore テスト
  - [x] calculateRSIMomentumScore テスト
  - [x] calculateEpsGrowthScore テスト
  - [x] calculateValueStockScore 統合テスト
- [x] 中期向け: RSIモメンタム（RSI_slope相当）— 短期RSIと長期RSIの差分で反発初動検出
- [x] 長期向け: EPS成長率（3年CAGR）— 成長力の直接指標
- [x] 出来高による罠株除外ロジック — 流動性の低い銘柄を除外
- [x] タグ情報のスコアリング組み込み（favorable/unfavorable）— マーケット分析で選定されたタグに基づくスコア加減点
- [ ] UIへの追加指標の反映
  - [ ] タグスコアの表示
  - [ ] EPS成長率の表示
  - [ ] 出来高情報の表示
- [ ] 追加指標の検討（実装するかは要検討）
  - [ ] 安値からの戻り率（bounce%）— 安値から+10〜20%が反発期待帯
  - [ ] 価格位置の異常値チェック — データ外れを弾く
  - [ ] β値（ボラティリティ）— 短期の反発期待の補助（高βは反発大きい）
  - [ ] forward PE（予想PER）— Yahoo Financeでは取得不可、別データソース要検討
  - [ ] 営業CF / FCF（キャッシュ創出力）— 成長持続性の裏付け
  - [ ] ROE / 利益率推移 — 質の高い成長かを判定
- [ ] 罠株判定の強化（実装するかは要検討）
  - [ ] 成長性指標の追加（売上高5年CAGR）
  - [ ] 利益安定性指標の追加（営業利益の変動係数）
  - [ ] 時価総額フィルタの追加
  - [ ] スコアリング重み調整
  - [ ] 過去の罠株での検証
- [ ] スコアリングロジックの精緻化（実装するかは要検討）
  - [ ] 業種特性を考慮した重み付け
  - [ ] マクロ経済指標の組み込み検討

### LINE通知機能の拡張 ✅ 完了
- [x] マーケット分析サマリのLINE通知
  - [x] 週次マーケット分析のサマリ作成
  - [x] LINE Messaging APIでの配信実装
  - [x] 配信タイミングの設計（月曜朝など）
  - [x] LINE登録者限定の配信ロジック
- [x] LINE通知メッセージの2通化
  - [x] 1通目: マーケットサマリ + 注目セクター
  - [x] 2通目: ランキング（上位5銘柄にAI分析コメント付き）
- [x] バッチ取得クエリサービスの実装（getStockAnalysesByStockIds）
- [x] メッセージビルダーの実装（lineMessageBuilders）
- [x] LINE銘柄即時分析機能 ✅ 完了
  - [x] LINEメッセージ受信Webhook実装
  - [x] 証券コードのパース処理（4桁コード対応）
  - [x] 期間選択機能（中期/長期のQuick Reply）
  - [x] 即時分析ロジック（OpenAI Responses API + Web検索）
  - [x] 分析結果のLINEメッセージフォーマット
  - [x] 使用回数制限の実装（Free: 月10回、Standard: 月30回、Pro: 月100回）
  - [x] 使用回数のカウント・リセット処理（月次リセット）
  - [x] タイムアウト処理（10分）とエラーハンドリング
  - [x] 運営連絡先の表示（エラー時）
- [x] LINEリッチメニューの実装 ✅ 完了
  - [x] リッチメニュー作成スクリプト（setup-line-richmenu.ts）
  - [x] AIで銘柄分析ボタン（使い方ガイド表示）
  - [x] レポートを再送ボタン（中期/長期選択Quick Reply）
  - [x] ダッシュボードボタン（ログインURL送信）

### ウォッチリスト機能の実装
- [ ] ウォッチリストテーブルの設計
- [ ] 銘柄追加・削除API実装
- [ ] ウォッチリスト表示UIの作成
- [ ] ウォッチリスト銘柄の通知設定
- [ ] 最大登録数の制限 (Free: 10銘柄, Premium: 100銘柄など)

---

## Phase 4: 課金機能実装

### 課金基盤
- [ ] Stripe連携
- [ ] サブスクリプションプランの実装
- [ ] 決済フローの実装
- [ ] 課金管理画面

### Premium機能の実装
- [ ] ウォッチリスト上限解除
- [ ] 通知フィルタリング機能
- [ ] 詳細分析レポート
- [ ] 優先サポート

---

## Phase 5: LLM分析機能の拡張

### LLMマーケット分析 ✅ 完了
- [x] LLM API (OpenAI) の選定とコスト検証
- [x] 日経平均のトレンド分析
- [x] セクター別トレンド分析
- [x] マーケットセンチメント分析
- [x] 週次・月次マーケット分析ジョブの実装
- [x] 分析結果のカード表示
- [x] 更新頻度の表示

### LLM個別株分析 ✅ 完了
- [x] OpenAI Responses APIの統合
- [x] Web検索機能の統合
- [x] 週次・月次個別株分析ジョブの実装
- [x] 分析結果の表示UI実装
- [x] プロンプトの中期/長期分離
  - [x] 中期: RSI（14週）、RSIモメンタム（2週-14週）、26週価格レンジ
  - [x] 長期: RSI（52週）、EPS成長率、52週価格レンジ
- [x] サマリー文字数制限の改善（Zod: 800字、プロンプト: 300-400字）
- [x] UI折りたたみ表示（300字超で「もっと読む」ボタン）
- [x] 情報不足時の評価ルール追加（情報不足なら fair 以下）
- [x] Web検索による情報補完の指示強化
- [x] 禁止事項の強化（URL、Sources:等の参照元表記の絶対禁止）

### Premium機能 (LLM) - 将来実装
- [ ] ユーザー指定銘柄のLLM深掘り分析
- [ ] カスタム分析プロンプトの実装
- [ ] 過去の分析履歴の保存と閲覧

---

## 将来的なタスク

### 通知フィルタリング
- [x] 市場別フィルター (東証プライム、スタンダードなど) - Backend API
- [x] 業種別フィルター - Backend API
- [x] 価格帯フィルター - Backend API
- [x] タグフィルター (マクロタグ、テーマタグ) - Backend API
- [x] フィルター適用ロジックの実装 - Backend API
- [ ] スコア範囲フィルター
- [ ] フィルター設定画面の作成
- [ ] 保存した設定の管理
- [ ] フィルター設定の保存 (DB)

### LINE連携フローの改善
- [ ] Web先行ユーザーのLINE連携UX改善
  - 現状の問題: WebでアカウントをいつくってからQRコードでLINE友だち追加しても、LINEからのリンクを再度タップしてログインしないと紐付けされない
  - 解決策案1: ログイン済みユーザーが `/login?lineUserId=xxx` にアクセスした場合、ログイン画面をスキップして直接 `linkLineAccount` を実行
  - 解決策案2: LIFFを使った連携フロー（QRコードにユーザーIDを含めた動的生成）
  - 参考ファイル: `src/app/api/line/webhook/route.ts`, `src/features/auth/components/LoginCard.tsx`

### その他の機能拡張
- [ ] ポートフォリオ管理機能
- [ ] 銘柄比較機能
- [ ] アラート機能の拡張
- [ ] 管理画面 (ユーザープラン管理、使用状況ダッシュボード)

### UI/UX改善 (継続的)
- [x] スコアリングロジックの説明ページ
- [ ] 初回ユーザー向けチュートリアル
- [ ] 機能紹介ツアー
- [ ] ヘルプ/FAQページ
