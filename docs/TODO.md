# TODO: スコアリング設計の改善

## 現状の課題

現在のスコアリング実装では、各指標（PER、PBR、RSI、価格レンジ、業種）が **5段階評価（0, 25, 50, 75, 100）** で計算されています。

### 現在の実装
- PER、PBR、RSI、価格レンジスコアは閾値ベースで5段階に分類
- 例: PER ≤ 10 → 100点、10-15 → 75点、15-20 → 50点、20-25 → 25点、25超 → 0点
- 総合スコア（totalScore）は各スコアの重み付け平均で0.0000～1.0000の範囲

### 問題点
- 生の指標値（実際のPER、PBRなど）がDBに保存されていない
- 5段階スコアだけでは細かい差が表現できない
- ユーザーが実際の指標値を確認できない

## 改善方針

### 1. データベースの保存
- **生の指標値をそのまま保存**
  - `per`, `pbr`, `rsi`, `currentPrice`, `fiftyTwoWeekHigh`, `fiftyTwoWeekLow` などの実数値
  - スコアは保存しない、または別カラムとして保存

### 2. UIでの表示
- **生の指標値をそのまま表示**
  - PER: 12.5、PBR: 0.85、RSI: 35.2 のように実数値で表示
  - **5段階での色分けによる視覚的な評価**
    - 例: 緑（非常に良い）、黄緑（良い）、黄色（普通）、オレンジ（やや悪い）、赤（悪い）

### 3. 割安度合いの計算
- **表示時やソート時に現在のスコアリングロジックを適用**
  - 生データから動的にスコアを計算
  - ソートや上位抽出は計算されたスコアで実行
  - スコアリングロジックの調整が容易に

### 実装の流れ

1. **スキーマ変更**
   - `stock_scores`テーブルに生の指標値カラムを追加
   - または新しいテーブル設計を検討

2. **ジョブの修正**
   - 週次・月次ジョブで生の指標値を保存

3. **クエリサービスの修正**
   - 生の指標値を取得

4. **フロントエンドの修正**
   - 生の指標値を表示
   - スコアリングロジックをフロントエンドまたはバックエンドで計算
   - 5段階の色分けを実装

5. **スコアリングロジックの分離**
   - 表示用のヘルパー関数として実装
   - 必要に応じてバックエンドでスコア計算用のエンドポイントを用意

## メリット
- 柔軟性: スコアリングロジックの変更が容易
- 透明性: ユーザーが実際の指標値を確認可能
- 拡張性: 新しい評価軸の追加が容易

---

# TODO: 価格レンジ評価期間の最適化

## 現状の課題

現在、週次ジョブと月次ジョブの両方で**52週（約1年間）の高値・安値**を使用して価格位置を評価しています。

### 現在の実装
```typescript
// 両方のジョブで同じデータを使用
const fundamentals = await getFundamentals(stock.tickerSymbol);
// fiftyTwoWeekHigh, fiftyTwoWeekLow (52週 = 約1年間)
```

### 問題点
- 週次ジョブ（短期評価）でも52週という長期レンジを使用している
- 週次と月次で評価期間が同じため、異なる時間軸での評価ができていない
- 短期的なトレンド変化を捉えにくい

## 改善方針

### 評価期間の最適化案

#### 1. 週次ジョブ（短期評価）
**推奨期間の候補:**
- **13週（約3ヶ月）**: 四半期ベースの評価
  - メリット: 短期トレンドを捉えやすい、決算サイクルとも一致
  - デメリット: ボラティリティが高い銘柄では変動が大きい

- **26週（約半年）**: 半期ベースの評価
  - メリット: 中期的なトレンドと短期的な動きのバランスが良い
  - デメリット: やや長めの評価になる可能性

- **20週（約5ヶ月）**:
  - メリット: 四半期と半期の中間、バランスの良い評価期間
  - デメリット: 特定のベンチマークと対応しない

**推奨: 26週（約半年）**
- 理由: 短期トレンドを捉えつつ、過度なノイズを避けられる
- 半期決算とも対応しやすい

#### 2. 月次ジョブ（長期評価）
**推奨期間:**
- **52週（約1年間）**: 現状維持
  - 理由: 年間を通じた長期トレンドを評価
  - 一般的な投資指標として広く認知されている
  - 多くの財務指標も年次ベースで評価される

### 実装の流れ

1. **データ取得の拡張**
   - `getWeeklyData()`や`getMonthlyData()`を活用して、異なる期間の高値・安値を計算
   - Yahoo Finance APIから取得した週次/月次データから、指定期間の最高値・最低値を算出

2. **設定の追加**
   ```typescript
   // scoringConfig.ts に追加
   export const SHORT_TERM_WEEKS = 26; // 週次ジョブ用
   export const LONG_TERM_WEEKS = 52;  // 月次ジョブ用
   ```

3. **ジョブの修正**
   ```typescript
   // weeklyStockScoring.ts
   const weeklyData = await getWeeklyData(stock.tickerSymbol, SHORT_TERM_WEEKS);
   const shortTermHigh = Math.max(...weeklyData.map(d => d.high));
   const shortTermLow = Math.min(...weeklyData.map(d => d.low));

   // monthlyStockScoring.ts
   // 現状の fiftyTwoWeekHigh/Low を継続使用
   ```

4. **スキーマの検討**
   - 評価期間（weeks）もDBに保存するか検討
   - または週次/月次で異なるカラム名を使用

5. **UIの表示**
   - 週次: "26週位置" または "半年位置"
   - 月次: "52週位置" または "年間位置"

### 期間選定の判断基準

**短期評価（週次）:**
- テクニカル分析的な視点: スイングトレード（数週間～数ヶ月）
- 四半期決算の影響を考慮
- **推奨: 26週（半年）**

**長期評価（月次）:**
- ファンダメンタル分析的な視点: 長期投資（1年以上）
- 年次決算、業績トレンドの評価
- **推奨: 52週（1年）を維持**

### 代替案

もし柔軟性を持たせたい場合:
- 週次: 13週、20週、26週を設定可能に
- 月次: 52週、78週（1.5年）、104週（2年）を設定可能に
- ユーザーが評価期間を選択できるUI

## メリット
- 異なる時間軸での評価が可能になる
- 短期トレンドと長期トレンドを分けて分析できる
- 投資スタイル（短期/長期）に応じた銘柄選定が可能
- より精緻なスクリーニングが実現できる
