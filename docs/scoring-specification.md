# StockSense スコアリング仕様書

## 📋 サービス概要

### 目的
底値圏・割安で今後の反転・上昇が期待できる銘柄を週次・月次で自動検出し、ユーザーにLINE通知する

### コンセプト
- **「すでに上昇トレンド」ではなく「底値圏からの反転期待」を重視**
- 売られすぎ・割安圏にある銘柄から、今後上昇する可能性がある銘柄を発掘
- 中期視点（週足・3〜6ヶ月）と長期視点（月足・1〜3年）の両面で評価

### 通知タイミング
- **中期スコア**: 週次（毎週土曜 0時）
- **長期スコア**: 月次（毎月1日 0時）
- スコア一定以下（例: 0.6未満）は永続化せず、高スコア銘柄のみ保存・通知

### 対象銘柄
- 初期フェーズ: **東証プライムのみ**（約1,800銘柄）
- 将来: スタンダード・グロース追加
- 通知対象: 上位20社 + ユーザーウォッチリスト

---

## 🧮 スコアリングロジック

### 総合スコア計算式

```
総合スコア = 中期スコア × 0.6 + 長期スコア × 0.4
```

### 中期スコア・長期スコアの計算

各スコアは以下の5つの要素から計算（0〜1に正規化）：

```
中期/長期スコア = (PERスコア + PBRスコア + RSIスコア + 価格位置スコア + 業種トレンドスコア) / 100
```

---

## 📊 スコア要素の詳細

### 1. PERスコア（割安性評価）

**データソース**:
- 個別銘柄PER: Yahoo Finance API (`quoteSummary` モジュール)
- 業種平均PER: JPX公式Excel（月次更新）

**計算ロジック**:
```typescript
PER相対値 = 個別銘柄PER / 業種平均PER

if (PER相対値 < 0.7)  → 20点  // 業種平均の70%未満 = 割安
if (PER相対値 < 1.0)  → 10点  // 業種平均未満
else                  → 0点
```

**除外条件**:
- PER ≤ 0（赤字企業）→ 0点

---

### 2. PBRスコア（割安性評価）

**データソース**:
- 個別銘柄PBR: Yahoo Finance API
- 業種平均PBR: JPX公式Excel（月次更新）

**計算ロジック**:
```typescript
PBR相対値 = 個別銘柄PBR / 業種平均PBR

if (PBR相対値 < 0.8)  → 20点  // 業種平均の80%未満 = 割安
if (PBR相対値 < 1.0)  → 10点  // 業種平均未満
else                  → 0点
```

**除外条件**:
- PBR ≤ 0（債務超過企業）→ 0点

---

### 3. RSIスコア（売られすぎ評価）

**データソース**: Yahoo Finance `historical` モジュールから株価取得 → RSI計算

**期間**:
- 中期: 14週間RSI（週足データ）
- 長期: 14ヶ月RSI（月足データ）

**計算ロジック**:
```typescript
if (RSI < 30)         → 20点  // 売られすぎ
if (RSI < 50)         → 10点  // やや売られすぎ
if (RSI < 70)         → 5点   // 中立
else                  → 0点   // 買われすぎ
```

**RSI計算式**:
```
RSI = 100 - (100 / (1 + RS))
RS = 平均上昇幅 / 平均下落幅（14期間）
```

---

### 4. 価格位置スコア（底値圏評価）

**データソース**: Yahoo Finance `historical` モジュール

**期間**:
- 中期: 過去6ヶ月の高値・安値
- 長期: 過去3年の高値・安値

**計算ロジック**:
```typescript
価格位置 = (現在価格 - 期間安値) / (期間高値 - 期間安値)

if (価格位置 < 0.2)   → 20点  // 安値圏（下位20%）
if (価格位置 < 0.4)   → 10点  // やや安値圏（下位40%）
else                  → 0点
```

---

### 5. 業種トレンドスコア（業種全体の勢い）

**データソース**: Yahoo Finance TOPIX業種別指数（例: `^TSEC.T`）

**期間**:
- 中期: 13週MA・26週MA
- 長期: 13ヶ月MA・26ヶ月MA

**計算ロジック**:
```typescript
if (業種指数MA13 > 業種指数MA26)  → 20点  // 業種が上昇トレンド
else                              → 0点
```

**移動平均計算**:
```
MA13 = 過去13期間の終値平均
MA26 = 過去26期間の終値平均
```

---

## 📂 データソース一覧

### Yahoo Finance API（無料）

| データ | APIモジュール | 取得頻度 |
|--------|--------------|----------|
| 個別銘柄PER | `quoteSummary` | 週次・月次 |
| 個別銘柄PBR | `quoteSummary` | 週次・月次 |
| 週足株価データ | `historical` (interval: '1wk') | 週次 |
| 月足株価データ | `historical` (interval: '1mo') | 月次 |
| 業種指数データ | `historical` | 週次・月次 |

**取得例**:
```typescript
// PER/PBR取得
const summary = await yahooFinance.quoteSummary('7203.T', {
  modules: ['defaultKeyStatistics', 'summaryDetail']
});
const per = summary.defaultKeyStatistics?.trailingPE;
const pbr = summary.summaryDetail?.priceToBook;

// 週足データ（過去1年）
const weeklyData = await yahooFinance.historical('7203.T', {
  period1: '2024-01-01',
  interval: '1wk'
});
```

### JPX公式データ（無料）

| データ | 形式 | 更新頻度 | URL |
|--------|------|----------|-----|
| 業種別平均PER/PBR | Excel | 毎月第1営業日 13時 | [JPX統計データ](https://www.jpx.co.jp/markets/statistics-equities/misc/04.html) |
| 銘柄マスターリスト | CSV | 随時（四半期確認） | [JPX市場統計](https://www.jpx.co.jp/markets/statistics-equities/misc/01.html) |

---

## 🎯 スコアの解釈

### スコアレンジ

| スコア範囲 | 評価 | 説明 |
|-----------|------|------|
| 0.8〜1.0 | 最高 | 非常に割安で反転期待が高い |
| 0.6〜0.8 | 高 | 割安で反転の可能性あり |
| 0.4〜0.6 | 中 | やや割安 |
| 0.0〜0.4 | 低 | 割安感なし or 上昇トレンド中 |

### 保存・通知基準

- **保存対象**: スコア 0.6以上
- **通知対象**: 上位20社（スコア降順）
- **将来**: ユーザーウォッチリスト内の銘柄も通知

---

## 🚫 除外条件（暫定）

以下の銘柄はスコア計算から除外する可能性あり（実装時に詳細決定）：

1. **財務異常**:
   - PER ≤ 0（赤字企業）
   - PBR ≤ 0（債務超過企業）

2. **新規上場**:
   - 上場後N日以内（例: 180日）は除外
   - 理由: データ不足・価格変動が大きい

3. **出来高不足**:
   - 平均出来高が基準以下（例: 1日10万株未満）
   - 理由: 流動性リスク

4. **特定業種**:
   - REITや特殊法人など、PER/PBRが適用できない業種

---

## 📈 計算例

### 例: トヨタ自動車（7203.T）

**中期スコア計算（週足ベース）**

| 要素 | 値 | スコア |
|------|-----|--------|
| PER（業種平均比） | 8.5 / 12.0 = 0.71 | 10点（0.7以上1.0未満） |
| PBR（業種平均比） | 0.9 / 1.2 = 0.75 | 20点（0.8未満） |
| RSI（14週） | 35 | 10点（30以上50未満） |
| 価格位置（6ヶ月） | 0.25 | 10点（0.2以上0.4未満） |
| 業種トレンド | MA13 > MA26 | 20点 |
| **合計** | | **70点 → 0.70** |

**長期スコア**: 0.65（同様に計算）

**総合スコア**:
```
0.70 × 0.6 + 0.65 × 0.4 = 0.42 + 0.26 = 0.68
```

→ **スコア 0.68（高評価）** → 保存・通知対象

---

## 🔄 スコア更新フロー

### 週次（中期スコア計算）

1. **事前処理**（月次で実行済み）:
   - 業種平均PER/PBR取得（JPX Excel）

2. **データ取得**:
   - 全プライム銘柄の週足データ取得（Yahoo Finance）
   - 個別銘柄PER/PBR取得

3. **計算**:
   - RSI計算（14週）
   - 移動平均計算（13週・26週）
   - 高値安値判定（6ヶ月）
   - 業種指数MA計算

4. **スコアリング**:
   - 各要素スコア計算
   - 中期スコア算出（0〜1）

5. **保存・通知**:
   - スコア 0.6以上のみDB保存
   - 上位20社を通知

### 月次（長期スコア計算）

- 週次と同様だが、月足データを使用
- 期間: RSI 14ヶ月、MA 13ヶ月・26ヶ月、高値安値 3年

---

## 🎯 実装フェーズ

### Phase 1: コアスコアリング機能（最優先）
**ゴール**: スコア計算ロジックの実装とInngestジョブでの自動実行

- スコアリングロジック実装（PER/PBR/RSI/価格位置/業種トレンド）
- Inngest週次・月次ジョブ実装
- 高スコア銘柄（0.6以上）のDB保存
- テスト実行・検証

**通知機能は後回し** - まずはスコア計算とDB保存に集中

### Phase 2: 通知機能（次フェーズ）
- LINE Notify統合
- 上位20銘柄の自動通知
- 通知テンプレート作成

### Phase 3: 将来の拡張案
- ウォッチリスト機能: ユーザーが任意の銘柄を登録
- スコア履歴表示: 過去のスコア推移をグラフ表示
- LLM補助分析: OpenAI APIで銘柄ニュース分析
- 除外条件のカスタマイズ: 時価総額・出来高などのフィルター設定
