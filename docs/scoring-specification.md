# StockSense スコアリング仕様書（最新版）

## 📋 サービス概要

### 目的
底値圏・割安で今後の反転・上昇が期待できる銘柄を中期・長期で自動検出し、ユーザーにLINE通知する

### コンセプト
- **「すでに上昇トレンド」ではなく「底値圏からの反転期待」を重視**
- 売られすぎ・割安圏にある銘柄から、今後上昇する可能性がある銘柄を発掘
- 中期視点（1〜6ヶ月）と長期視点（6ヶ月〜3年）の両面で評価

### 処理・通知タイミング
- **中期スコア処理**: 毎週土曜 0:00〜4:00 JST（データ収集→マーケット分析→個別株分析）
- **中期LINE通知**: 毎週月曜 7:00 JST
- **長期スコア処理**: 毎月1日 0:00〜4:00 JST（データ収集→マーケット分析→個別株分析）
- **長期LINE通知**: 毎月1日〜3日の最初の平日 7:00 JST
- 通知対象: 上位10銘柄

### 対象銘柄
- **東証プライム、スタンダード、グロース**
- **PROマーケット除外**（機関投資家向け市場）
- **罠銘柄除外**（財務健全性の低い銘柄）

### 取得データ一覧

#### スコアリングに使用するデータ
| データ | 用途 | ソース | 更新頻度 |
|--------|------|--------|----------|
| 現在株価 | 価格位置計算 | Yahoo Finance API | 週次/月次 |
| PER（株価収益率） | 割安性評価 | Yahoo Finance API | 週次/月次 |
| PBR（株価純資産倍率） | 割安性評価 | Yahoo Finance API | 週次/月次 |
| 週足株価データ | RSI計算、高値/安値取得 | Yahoo Finance API | 週次/月次 |
| 業種別平均PER | 業種比較 | JPX公式Excel | 月次（手動） |
| 業種別平均PBR | 業種比較 | JPX公式Excel | 月次（手動） |

#### 罠銘柄判定・長期スコアリングに使用するデータ
| データ | 用途 | ソース | 更新頻度 |
|--------|------|--------|----------|
| 自己資本比率 | 財務安定性判定 | Yahoo Finance API | 月次 |
| ROE（自己資本利益率） | 収益性判定 | Yahoo Finance API | 月次 |
| 営業利益減少年数 | 利益トレンド判定 | Yahoo Finance API | 月次 |
| 営業CF負の年数 | キャッシュフロー健全性 | Yahoo Finance API | 月次 |
| 売上減少年数 | 成長性判定 | Yahoo Finance API | 月次 |
| 最新年度EPS | EPS成長率計算（長期） | Yahoo Finance API | 月次 |
| 3年前EPS | EPS成長率計算（長期） | Yahoo Finance API | 月次 |

#### 銘柄マスターデータ
| データ | 用途 | ソース | 更新頻度 |
|--------|------|--------|----------|
| 銘柄コード | 銘柄識別 | JPX公式CSV | 四半期（手動） |
| 銘柄名 | 表示用 | JPX公式CSV | 四半期（手動） |
| 市場区分 | 市場別補正、罠判定 | JPX公式CSV | 四半期（手動） |
| 業種コード | 業種平均との紐付け | JPX公式CSV | 四半期（手動） |

---

## 🧮 スコアリングロジック

### 総合スコア計算式

中期・長期それぞれで独立してスコアを算出し、各期間で上位10銘柄を抽出します。

**中期スコア計算式**:
```
総合スコア = (PERスコア × 26% + PBRスコア × 20% + RSIスコア × 18% + 価格位置スコア × 14% + RSIモメンタムスコア × 22%) / 100
```

**長期スコア計算式**:
```
総合スコア = (PERスコア × 28% + PBRスコア × 25% + RSIスコア × 15% + 価格位置スコア × 12% + EPS成長率スコア × 20%) / 100
```

### 中期・長期の重み配分

#### 中期スコア（1〜6ヶ月投資）
```
PER: 26%           # 割安性評価
PBR: 20%           # 割安性評価
RSI（静的）: 18%   # 売られすぎ評価（14週RSI）
価格位置: 14%      # 底値圏評価（26週高安レンジ）
RSIモメンタム: 22% # 反発初動検出（短期RSI - 長期RSI）
合計: 100%
```

**中期の特徴**:
- RSIモメンタム（短期RSI 2週 - 長期RSI 14週）で**反発の初動**を検出
- 「割安かつ反発し始めた銘柄」を高く評価

#### 長期スコア（6ヶ月〜3年投資）
```
PER: 28%           # 割安性評価
PBR: 25%           # 割安性評価
RSI（静的）: 15%   # 売られすぎ評価（52週RSI）
価格位置: 12%      # 底値圏評価（52週高安レンジ）
EPS成長率: 20%     # 利益成長性評価（3年CAGR）
合計: 100%
```

**長期の特徴**:
- EPS成長率（3年CAGR）で**持続的な利益成長**を評価
- 「割安でありながら着実に利益を伸ばしている銘柄」を高く評価

---

## 📊 スコア要素の詳細

### 1. PERスコア（割安性評価）

**データソース**:
- 個別銘柄PER: Yahoo Finance API (`quoteSummary` モジュール)
- 業種平均PER: JPX公式Excel（月次更新）

**計算ロジック（線形スケール 0-100点）**:
```typescript
ratio = (個別銘柄PER / 業種平均PER) × 100

// 線形補間によるスコア計算
if (ratio <= 70%)        → 100点  // 優良（業種平均の70%以下）
if (ratio <= 100%)       → 100点〜50点（線形補間）
if (ratio <= 150%)       → 50点〜0点（線形補間）
if (ratio > 150%)        → 0点    // 割高

// 市場別補正を適用
adjusted = score × 市場別補正係数
final = clamp(adjusted, 0, 100)  // 0-100にクリップ
```

**除外条件**:
- PER ≤ 0（赤字企業）→ 0点
- 業種平均PER ≤ 0 → 0点

---

### 2. PBRスコア（割安性評価）

**データソース**:
- 個別銘柄PBR: Yahoo Finance API
- 業種平均PBR: JPX公式Excel（月次更新）

**計算ロジック（線形スケール 0-100点）**:
```typescript
ratio = (個別銘柄PBR / 業種平均PBR) × 100

// 線形補間によるスコア計算
if (ratio <= 70%)        → 100点  // 優良（業種平均の70%以下）
if (ratio <= 100%)       → 100点〜50点（線形補間）
if (ratio <= 150%)       → 50点〜0点（線形補間）
if (ratio > 150%)        → 0点    // 割高

// 市場別補正を適用
adjusted = score × 市場別補正係数
final = clamp(adjusted, 0, 100)  // 0-100にクリップ
```

**除外条件**:
- PBR ≤ 0（債務超過企業）→ 0点
- 業種平均PBR ≤ 0 → 0点

---

### 3. RSIスコア（売られすぎ評価）

**データソース**: Yahoo Finance `historical` モジュールから週足株価データを取得 → RSI計算

**期間**:
- 中期: 14週RSI（週足データ14週間分）
- 長期: 52週RSI（週足データ52週間分）

**計算ロジック（線形スケール 0-100点）**:
```typescript
// 線形補間によるスコア計算
if (RSI <= 30)          → 100点  // 売られすぎ
if (RSI <= 50)          → 100点〜50点（線形補間）
if (RSI <= 70)          → 50点〜0点（線形補間）
if (RSI > 70)           → 0点    // 買われすぎ
```

**RSI計算式**:
```
RSI = 100 - (100 / (1 + RS))
RS = 平均上昇幅 / 平均下落幅（14期間）
```

**除外条件**:
- RSI = null → 0点

---

### 4. 価格位置スコア（底値圏評価）

**データソース**: Yahoo Finance `historical` モジュール

**期間**:
- 中期: 過去26週の高値・安値
- 長期: 過去52週の高値・安値

**計算ロジック（線形スケール 0-100点）**:
```typescript
価格位置 = (現在価格 - 期間安値) / (期間高値 - 期間安値) × 100

// 線形補間によるスコア計算
if (価格位置 <= 20%)    → 100点  // 底値圏
if (価格位置 <= 40%)    → 100点〜50点（線形補間）
if (価格位置 <= 100%)   → 50点〜0点（線形補間）

// 市場別補正を適用
adjusted = score × 市場別補正係数
final = clamp(adjusted, 0, 100)  // 0-100にクリップ
```

**除外条件**:
- 現在価格 = null → 0点
- 期間高値 = null → 0点
- 期間安値 = null → 0点
- 期間高値 = 期間安値 → 0点
- 現在価格 < 期間安値 → 0点（データ不整合を検出）
- 現在価格 > 期間高値 → 0点（データ不整合を検出）

**異常値チェック**:
Yahoo Financeデータの欠損や不整合を早期検出し、誤ったスコアの算出を防止します。異常値が検出された場合は警告ログを出力し、当該銘柄のスコアを0点とします。

---

### 5. RSIモメンタムスコア（反発初動検出）【中期のみ】

**概要**: 短期RSIと長期RSIの差分から、売られすぎからの反発初動を検出

**データソース**: Yahoo Finance `historical` モジュールから週足株価データを取得 → RSI計算

**期間**:
- 短期RSI: 2週
- 長期RSI: 14週

**計算ロジック**:
```typescript
// RSIモメンタム = 短期RSI - 長期RSI
momentum = rsiShort (2週) - rsi (14週)

// モメンタムの解釈:
// - 正の値: 上昇モメンタム（売られすぎから反発初動）
// - 負の値: 下降モメンタム（まだ下落継続）

// スコア変換（-30〜+30 を 0〜100 にマッピング）
if (momentum <= -30)    → 0点    // 強い下降モメンタム
if (momentum == 0)      → 50点   // モメンタムなし
if (momentum >= +30)    → 100点  // 強い上昇モメンタム

// 線形補間: score = ((momentum + 30) / 60) × 100
final = clamp(score, 0, 100)
```

**投資意図**:
- バリュー株投資では「割安かつ反発し始めた銘柄」が理想的
- 短期RSIが長期RSIを上回り始めた銘柄 = エントリータイミングが良い
- 短期的な反発の兆しを検出し、中期投資のタイミングを最適化

**除外条件**:
- 短期RSI = null → 50点（中央値）
- 長期RSI = null → 50点（中央値）

---

### 6. EPS成長率スコア（利益成長性評価）【長期のみ】

**概要**: 3年間のEPS（1株当たり利益）成長率から、持続的な利益成長を評価

**データソース**: Yahoo Finance `fundamentalsTimeSeries` モジュール

**使用データ**:
- `dilutedEPS`（希薄化後EPS）を優先
- `dilutedEPS`がない場合は`basicEPS`（基本EPS）を使用
- 最新年度のEPSと3年前のEPSを取得

**計算ロジック**:
```typescript
// EPS成長率（CAGR）= ((最新EPS / 3年前EPS)^(1/3) - 1) × 100
// 例: 3年前EPS=100円、最新EPS=133円 → CAGR = 10%

// 計算不可のケース（50点を返す）:
// - どちらかがnull
// - 3年前のEPSが0以下（負のEPSからの成長率は意味をなさない）
// - 最新のEPSが負（赤字転落）

// スコアリング:
if (growthRate < 0%)     → 0点     // マイナス成長
if (growthRate <= 10%)   → 0-50点  // 低成長（線形補間）
if (growthRate <= 20%)   → 50-100点 // 良好な成長（線形補間）
if (growthRate > 20%)    → 100点   // 高成長
```

**投資意図**:
- 長期バリュー投資では「割安でありながら着実に利益を伸ばしている銘柄」が理想的
- 年率10%以上のEPS成長は優良企業の証
- 年率20%以上は成長株としても評価できるレベル

**除外条件**:
- 最新EPS = null → 50点（中央値）
- 3年前EPS = null → 50点（中央値）
- 3年前EPS ≤ 0 → 50点（計算不可）
- 最新EPS < 0 → 50点（赤字転落は別途評価が必要）

---

### 7. 市場別補正係数

スコア計算時に市場特性を考慮した補正を適用

| 市場 | PER補正 | PBR補正 | 価格位置補正 |
|------|---------|---------|-------------|
| プライム | 1.0 | 1.0 | 1.0 |
| スタンダード | 1.05 | 1.0 | 1.05 |
| グロース | 1.2 | 0.8 | 0.95 |
| その他 | 1.0 | 1.0 | 1.0 |

**補正の意図**:
- **グロース市場**: PERを重視（20%増）、PBRを軽視（20%減）
  - 理由: グロース企業は「PER低い＝必ずしも良い銘柄ではない」
  - 成長性期待が株価に織り込まれているため、PERよりも成長率が重要
  - PBRは資産ベースの評価で成長企業には不向き
- **スタンダード市場**: PERと価格位置を若干優遇（5%増）
  - 理由: 割安株が多く存在する市場特性

---

## 🚫 除外条件

### 1. PROマーケット除外
```typescript
除外条件: 市場名に "PRO" または "プロ" が含まれる
理由: TOKYO PRO Marketは機関投資家向け市場で個人投資家向けではない
```

### 2. 罠銘柄除外（市場別）

財務健全性が低く、見かけ上は割安でも投資リスクが高い「罠銘柄」を除外します。
市場ごとに企業特性が異なるため、判定基準も市場別に設定しています。

#### プライム市場（大型・安定企業）
以下のいずれかに該当する場合、罠銘柄として除外：
- 自己資本比率が25%未満
- ROEが3%未満
- 営業利益が3年連続で減少
- 営業キャッシュフローが2年連続でマイナス

#### スタンダード市場（中堅企業）
以下のいずれかに該当する場合、罠銘柄として除外：
- 自己資本比率が20%未満
- 営業利益が2年連続で減少
- 営業キャッシュフローが2年連続でマイナス

#### グロース市場（成長企業）
成長企業は赤字でも成長性があれば許容されるため、基準を緩和しています。
以下のいずれかに該当する場合、罠銘柄として除外：
- 自己資本比率が10%未満
- 営業キャッシュフローが3年連続でマイナス
- 売上が3年連続で減少（成長企業なのに縮小は問題）

#### その他市場
以下のいずれかに該当する場合、罠銘柄として除外：
- 自己資本比率が20%未満
- 営業利益が3年連続で減少
- 営業キャッシュフローが2年連続でマイナス

#### 判定の考え方
- **自己資本比率**: 財務の安定性を示す。低すぎると倒産リスクが高い
- **ROE**: 株主資本に対する利益率。プライム企業は安定した収益性が求められる
- **営業利益の連続減少**: 本業の競争力低下を示す
- **営業CFの連続マイナス**: 本業でキャッシュを生み出せていない危険な状態
- **売上の連続減少**: グロース企業にとって成長停止は致命的

---

## 📂 データソース一覧

### Yahoo Finance API（無料）

| データ | APIモジュール | 取得頻度 |
|--------|--------------|----------|
| 個別銘柄PER | `quoteSummary` | 週次 |
| 個別銘柄PBR | `quoteSummary` | 週次 |
| 週足株価データ | `historical` (interval: '1wk') | 週次 |
| RSI計算用データ | `historical` | 週次 |

**取得例**:
```typescript
// PER/PBR取得
const summary = await yahooFinance.quoteSummary('7203.T', {
  modules: ['defaultKeyStatistics', 'summaryDetail']
});
const per = summary.defaultKeyStatistics?.trailingPE;
const pbr = summary.summaryDetail?.priceToBook;

// 週足データ
const weeklyData = await yahooFinance.historical('7203.T', {
  period1: '2024-01-01',
  interval: '1wk'
});
```

### JPX公式データ（無料）

| データ | 形式 | 更新頻度 | URL |
|--------|------|----------|-----|
| 業種別平均PER/PBR | Excel | 毎月第1営業日 13時 | [JPX統計データ](https://www.jpx.co.jp/markets/statistics-equities/misc/04.html) |
| 銘柄マスターリスト | CSV | 随時（四半期確認） | [JPX市場統計](https://www.jpx.co.jp/markets/statistics-equities/misc/01.html) |

---

## 🎯 スコアの解釈

### スコアレンジ

総合スコアは0.0〜1.0の範囲で算出されます。

| スコア範囲 | 評価 | 説明 |
|-----------|------|------|
| 0.8〜1.0 | 最高 | 非常に割安で反転期待が高い |
| 0.6〜0.8 | 高 | 割安で反転の可能性あり |
| 0.4〜0.6 | 中 | やや割安 |
| 0.0〜0.4 | 低 | 割安感なし or 上昇トレンド中 |

### 通知基準

- **通知対象**: 上位10銘柄（スコア降順）
- 中期・長期でそれぞれ独立して10銘柄を抽出
- 週次LINE通知: 中期上位10銘柄
- 月次LINE通知: 長期上位10銘柄

---

## 📈 計算例

### 例: トヨタ自動車（7203.T）中期スコア

#### 入力データ
```
個別銘柄PER: 8.5
業種平均PER: 12.0
個別銘柄PBR: 0.9
業種平均PBR: 1.2
RSI (14週): 35
価格位置: 25% (期間安値から25%の位置)
市場: プライム
```

#### 各スコア計算

**PERスコア**:
```
ratio = (8.5 / 12.0) × 100 = 70.8%
→ 70%〜100%の範囲なので線形補間
→ baseScore ≈ 96点
→ 市場補正 (プライム): 96 × 1.0 = 96点
```

**PBRスコア**:
```
ratio = (0.9 / 1.2) × 100 = 75%
→ 70%〜100%の範囲なので線形補間
→ baseScore ≈ 91点
→ 市場補正 (プライム): 91 × 1.0 = 91点
```

**RSIスコア**:
```
RSI = 35
→ 30〜50の範囲なので線形補間
→ score ≈ 75点
```

**価格位置スコア**:
```
価格位置 = 25%
→ 20%〜40%の範囲なので線形補間
→ baseScore ≈ 87点
→ 市場補正 (プライム): 87 × 1.0 = 87点
```

#### 総合スコア
```
totalScore = (
  96 × 0.28 +   // PER: 26.88
  91 × 0.22 +   // PBR: 20.02
  75 × 0.33 +   // RSI: 24.75
  87 × 0.17     // 価格位置: 14.79
) / 100

= 86.44 / 100
= 0.8644

→ スコア 0.86（最高評価）
```

---

## 🔄 実装フロー

### データフロー

```
1. getLatestIndicators (クエリサービス)
   - DBから最新の指標データ取得
   - 銘柄情報と業種平均をJOINして取得
   ↓
2. filterProMarket (ドメインサービス)
   - PROマーケット銘柄を除外
   ↓
3. filterTrapStocks (ドメインサービス)
   - 罠銘柄（財務健全性が低い銘柄）を除外
   ↓
4. calculateScores (ドメインサービス)
   - 各銘柄のスコアを計算
   - configの閾値と重みを使用
   - 市場別補正を適用
   ↓
5. rankByScore (ドメインサービス)
   - スコア順にソート
   - 上位N件を抽出
   ↓
6. DTOにパースして返却
```

### 週次ジョブ（中期スコア）

**土曜日深夜（データ処理）**
1. 0:00 - 指標収集ジョブ: 全銘柄の週足データ取得、14週RSI/26週レンジ計算
2. 2:00 - マーケット分析ジョブ: LLMによる中期マーケット分析
3. 4:00 - 個別株分析ジョブ: 上位5銘柄のLLM個別分析

**月曜日朝（通知）**
4. 7:00 - LINE通知ジョブ: 上位10銘柄をユーザーに通知

### 月次ジョブ（長期スコア）

**毎月1日深夜（データ処理）**
1. 0:00 - 指標収集ジョブ: 全銘柄の52週RSI/52週レンジ計算
2. 0:00 - 財務健全性収集ジョブ: 全銘柄の財務データ取得（同時実行）
3. 2:00 - マーケット分析ジョブ: LLMによる長期マーケット分析
4. 4:00 - 個別株分析ジョブ: 上位5銘柄のLLM個別分析

**毎月1日〜3日の最初の平日（通知）**
5. 7:00 - LINE通知ジョブ: 上位10銘柄をユーザーに通知（平日のみ実行）

### 手動実行ジョブ

**業種平均データ更新**
- トリガー: `sector-averages/update` イベント
- 内容: JPX公式Excelから業種別平均PER/PBRを更新
- 実行: Inngest Dashboardから手動実行、またはAPIで `inngest.send({ name: "sector-averages/update" })`

---

## 🔧 設定ファイル

スコアリングの重みや閾値は `scoringConfig.ts` で一元管理されており、調整が容易です。

### 中期設定 (MID_TERM_CONFIG)
```typescript
{
  // 重み配分（合計100%）
  perWeight: 26,           // PERスコア
  pbrWeight: 20,           // PBRスコア
  rsiWeight: 18,           // RSI静的スコア
  priceRangeWeight: 14,    // 価格位置スコア
  rsiMomentumWeight: 22,   // RSIモメンタムスコア（中期のみ）

  // 閾値
  perThresholds: { excellent: 70, good: 100 },
  pbrThresholds: { excellent: 70, good: 100 },
  rsiThresholds: { oversold: 30, neutral: 50 },
  priceRangeThresholds: { bottom: 20, low: 40 },

  // 市場別補正係数
  marketAdjustments: {
    prime: { per: 1.0, pbr: 1.0, priceRange: 1.0 },
    standard: { per: 1.05, pbr: 1.0, priceRange: 1.05 },
    growth: { per: 1.2, pbr: 0.8, priceRange: 0.95 }, // グロースはPER重視、PBR軽視
    other: { per: 1.0, pbr: 1.0, priceRange: 1.0 },
  }
}
```

### 長期設定 (LONG_TERM_CONFIG)
```typescript
{
  // 重み配分（合計100%）
  perWeight: 28,           // PERスコア
  pbrWeight: 25,           // PBRスコア
  rsiWeight: 15,           // RSI静的スコア
  priceRangeWeight: 12,    // 価格位置スコア
  epsGrowthWeight: 20,     // EPS成長率スコア（長期のみ）

  // 閾値と市場別補正は中期と同じ設定
}
```

---

## 🎯 将来の拡張計画

### TODO: 業種トレンドスコアの実装

現在は未実装ですが、将来的に以下の機能を追加予定:

**概要**: 業種全体のトレンドを評価し、スコアに加算

**データソース**: TOPIX業種別指数（例: `^TSEC.T`）

**計算ロジック**:
```typescript
// 業種指数の移動平均を取得
MA13 = 過去13期間の業種指数平均
MA26 = 過去26期間の業種指数平均

// トレンド判定
if (MA13 > MA26) {
  // 業種が上昇トレンド → 加点
} else {
  // 業種が下降/横ばい → 0点
}
```

**メリット**: 「個別銘柄は割安だが業種全体が弱い」銘柄と「個別銘柄が割安で業種も強い」銘柄を区別可能

---

## 📝 変更履歴

### 2025-11-29 v2 (最新)
- **中期スコアにRSIモメンタムを追加**: 短期RSI(2週) - 長期RSI(14週)の差分で反発初動を検出
- **長期スコアにEPS成長率を追加**: 3年CAGRで持続的な利益成長を評価
- **重み配分を大幅更新**:
  - 中期: PER 26%, PBR 20%, RSI静的 18%, 価格位置 14%, RSIモメンタム 22%
  - 長期: PER 28%, PBR 25%, RSI静的 15%, 価格位置 12%, EPS成長率 20%
- **取得データ一覧にEPSデータを追加**: dilutedEPS/basicEPSをYahoo Finance APIから取得
- **LLMプロンプトを更新**: 中期にRSIモメンタム説明、長期にEPS成長率説明を追加

### 2025-11-29
- **処理・通知タイミングを更新**: 土曜深夜処理 → 月曜7:00通知に変更
- **RSI説明を修正**: 長期RSIは月足ではなく週足データ52週分を使用
- **罠銘柄除外ロジックの詳細説明を追加**: 市場別の判定基準と考え方を記載
- **ジョブフローを詳細化**: 週次・月次それぞれのジョブ実行順序を明記
- **手動実行ジョブを追記**: 業種平均データ更新ジョブの説明を追加

### 2025-11-26
- **未使用のSCORE_THRESHOLD定数を削除**
  - 現在の実装ではスコア計算後に上位N件取得するため不要
- **グロース市場補正を見直し**: PER 1.1→1.2、PBR 0.9→0.8
  - グロース企業の特性（成長期待重視）により適合
- **価格位置の異常値チェックを追加**: データ不整合を早期検出
  - 現在価格が期間レンジ外の場合は0点+警告ログ出力

### 2025-11-26 (初版)
- スコア計算を10段階から線形スケール（0-100）に変更
- 重みを100%に正規化（中期: 28/22/33/17、長期: 35/30/18/17）
- 市場別補正を小幅調整（±10%以内）に変更
- clamp処理を追加して異常値を防止
- scoringConfigを適切に設計し、閾値を計算ロジックで使用
- PROマーケット除外、罠銘柄除外フィルターを実装
- ドキュメントを最新の実装に合わせて全面改訂
