# StockSense スコアリング仕様書（最新版）

## 📋 サービス概要

### 目的
底値圏・割安で今後の反転・上昇が期待できる銘柄を中期・長期で自動検出し、ユーザーにLINE通知する

### コンセプト
- **「すでに上昇トレンド」ではなく「底値圏からの反転期待」を重視**
- 売られすぎ・割安圏にある銘柄から、今後上昇する可能性がある銘柄を発掘
- 中期視点（1〜6ヶ月）と長期視点（6ヶ月〜3年）の両面で評価

### 通知タイミング
- **中期スコア**: 週次（毎週月曜8:00 JST）
- **長期スコア**: 月次（毎月1日〜3日の最初の平日 8:00 JST）
- 通知対象: 上位10銘柄

### 対象銘柄
- **東証プライム、スタンダード、グロース**
- **PROマーケット除外**（機関投資家向け市場）
- **罠銘柄除外**（財務健全性の低い銘柄）

---

## 🧮 スコアリングロジック

### 総合スコア計算式

中期・長期それぞれで独立してスコアを算出し、各期間で上位10銘柄を抽出します。

```
総合スコア = (PERスコア × 重み + PBRスコア × 重み + RSIスコア × 重み + 価格位置スコア × 重み) / 100
```

### 中期・長期の重み配分

#### 中期スコア（1〜6ヶ月投資）
```
PER: 28%
PBR: 22%
RSI: 33%
価格位置: 17%
合計: 100%
```

#### 長期スコア（6ヶ月〜3年投資）
```
PER: 35%
PBR: 30%
RSI: 18%
価格位置: 17%
合計: 100%
```

---

## 📊 スコア要素の詳細

### 1. PERスコア（割安性評価）

**データソース**:
- 個別銘柄PER: Yahoo Finance API (`quoteSummary` モジュール)
- 業種平均PER: JPX公式Excel（月次更新）

**計算ロジック（線形スケール 0-100点）**:
```typescript
ratio = (個別銘柄PER / 業種平均PER) × 100

// 線形補間によるスコア計算
if (ratio <= 70%)        → 100点  // 優良（業種平均の70%以下）
if (ratio <= 100%)       → 100点〜50点（線形補間）
if (ratio <= 150%)       → 50点〜0点（線形補間）
if (ratio > 150%)        → 0点    // 割高

// 市場別補正を適用
adjusted = score × 市場別補正係数
final = clamp(adjusted, 0, 100)  // 0-100にクリップ
```

**除外条件**:
- PER ≤ 0（赤字企業）→ 0点
- 業種平均PER ≤ 0 → 0点

---

### 2. PBRスコア（割安性評価）

**データソース**:
- 個別銘柄PBR: Yahoo Finance API
- 業種平均PBR: JPX公式Excel（月次更新）

**計算ロジック（線形スケール 0-100点）**:
```typescript
ratio = (個別銘柄PBR / 業種平均PBR) × 100

// 線形補間によるスコア計算
if (ratio <= 70%)        → 100点  // 優良（業種平均の70%以下）
if (ratio <= 100%)       → 100点〜50点（線形補間）
if (ratio <= 150%)       → 50点〜0点（線形補間）
if (ratio > 150%)        → 0点    // 割高

// 市場別補正を適用
adjusted = score × 市場別補正係数
final = clamp(adjusted, 0, 100)  // 0-100にクリップ
```

**除外条件**:
- PBR ≤ 0（債務超過企業）→ 0点
- 業種平均PBR ≤ 0 → 0点

---

### 3. RSIスコア（売られすぎ評価）

**データソース**: Yahoo Finance `historical` モジュールから株価取得 → RSI計算

**期間**:
- 中期: 14週間RSI（週足データ）
- 長期: 52週間RSI（月足データ）

**計算ロジック（線形スケール 0-100点）**:
```typescript
// 線形補間によるスコア計算
if (RSI <= 30)          → 100点  // 売られすぎ
if (RSI <= 50)          → 100点〜50点（線形補間）
if (RSI <= 70)          → 50点〜0点（線形補間）
if (RSI > 70)           → 0点    // 買われすぎ
```

**RSI計算式**:
```
RSI = 100 - (100 / (1 + RS))
RS = 平均上昇幅 / 平均下落幅（14期間）
```

**除外条件**:
- RSI = null → 0点

---

### 4. 価格位置スコア（底値圏評価）

**データソース**: Yahoo Finance `historical` モジュール

**期間**:
- 中期: 過去26週の高値・安値
- 長期: 過去52週の高値・安値

**計算ロジック（線形スケール 0-100点）**:
```typescript
価格位置 = (現在価格 - 期間安値) / (期間高値 - 期間安値) × 100

// 線形補間によるスコア計算
if (価格位置 <= 20%)    → 100点  // 底値圏
if (価格位置 <= 40%)    → 100点〜50点（線形補間）
if (価格位置 <= 100%)   → 50点〜0点（線形補間）

// 市場別補正を適用
adjusted = score × 市場別補正係数
final = clamp(adjusted, 0, 100)  // 0-100にクリップ
```

**除外条件**:
- 現在価格 = null → 0点
- 期間高値 = null → 0点
- 期間安値 = null → 0点
- 期間高値 = 期間安値 → 0点
- 現在価格 < 期間安値 → 0点（データ不整合を検出）
- 現在価格 > 期間高値 → 0点（データ不整合を検出）

**異常値チェック**:
Yahoo Financeデータの欠損や不整合を早期検出し、誤ったスコアの算出を防止します。異常値が検出された場合は警告ログを出力し、当該銘柄のスコアを0点とします。

---

### 5. 市場別補正係数

スコア計算時に市場特性を考慮した補正を適用

| 市場 | PER補正 | PBR補正 | 価格位置補正 |
|------|---------|---------|-------------|
| プライム | 1.0 | 1.0 | 1.0 |
| スタンダード | 1.05 | 1.0 | 1.05 |
| グロース | 1.2 | 0.8 | 0.95 |
| その他 | 1.0 | 1.0 | 1.0 |

**補正の意図**:
- **グロース市場**: PERを重視（20%増）、PBRを軽視（20%減）
  - 理由: グロース企業は「PER低い＝必ずしも良い銘柄ではない」
  - 成長性期待が株価に織り込まれているため、PERよりも成長率が重要
  - PBRは資産ベースの評価で成長企業には不向き
- **スタンダード市場**: PERと価格位置を若干優遇（5%増）
  - 理由: 割安株が多く存在する市場特性

---

## 🚫 除外条件

### 1. PROマーケット除外
```typescript
除外条件: 市場名に "PRO" または "プロ" が含まれる
理由: TOKYO PRO Marketは機関投資家向け市場で個人投資家向けではない
```

### 2. 罠銘柄除外
```typescript
isTrapStock判定により財務健全性の低い銘柄を除外
- 詳細ロジックは isTrapStock.service.ts に実装
```

---

## 📂 データソース一覧

### Yahoo Finance API（無料）

| データ | APIモジュール | 取得頻度 |
|--------|--------------|----------|
| 個別銘柄PER | `quoteSummary` | 週次 |
| 個別銘柄PBR | `quoteSummary` | 週次 |
| 週足株価データ | `historical` (interval: '1wk') | 週次 |
| RSI計算用データ | `historical` | 週次 |

**取得例**:
```typescript
// PER/PBR取得
const summary = await yahooFinance.quoteSummary('7203.T', {
  modules: ['defaultKeyStatistics', 'summaryDetail']
});
const per = summary.defaultKeyStatistics?.trailingPE;
const pbr = summary.summaryDetail?.priceToBook;

// 週足データ
const weeklyData = await yahooFinance.historical('7203.T', {
  period1: '2024-01-01',
  interval: '1wk'
});
```

### JPX公式データ（無料）

| データ | 形式 | 更新頻度 | URL |
|--------|------|----------|-----|
| 業種別平均PER/PBR | Excel | 毎月第1営業日 13時 | [JPX統計データ](https://www.jpx.co.jp/markets/statistics-equities/misc/04.html) |
| 銘柄マスターリスト | CSV | 随時（四半期確認） | [JPX市場統計](https://www.jpx.co.jp/markets/statistics-equities/misc/01.html) |

---

## 🎯 スコアの解釈

### スコアレンジ

総合スコアは0.0〜1.0の範囲で算出されます。

| スコア範囲 | 評価 | 説明 |
|-----------|------|------|
| 0.8〜1.0 | 最高 | 非常に割安で反転期待が高い |
| 0.6〜0.8 | 高 | 割安で反転の可能性あり |
| 0.4〜0.6 | 中 | やや割安 |
| 0.0〜0.4 | 低 | 割安感なし or 上昇トレンド中 |

### 通知基準

- **通知対象**: 上位10銘柄（スコア降順）
- 中期・長期でそれぞれ独立して10銘柄を抽出
- 週次LINE通知: 中期上位10銘柄
- 月次LINE通知: 長期上位10銘柄

---

## 📈 計算例

### 例: トヨタ自動車（7203.T）中期スコア

#### 入力データ
```
個別銘柄PER: 8.5
業種平均PER: 12.0
個別銘柄PBR: 0.9
業種平均PBR: 1.2
RSI (14週): 35
価格位置: 25% (期間安値から25%の位置)
市場: プライム
```

#### 各スコア計算

**PERスコア**:
```
ratio = (8.5 / 12.0) × 100 = 70.8%
→ 70%〜100%の範囲なので線形補間
→ baseScore ≈ 96点
→ 市場補正 (プライム): 96 × 1.0 = 96点
```

**PBRスコア**:
```
ratio = (0.9 / 1.2) × 100 = 75%
→ 70%〜100%の範囲なので線形補間
→ baseScore ≈ 91点
→ 市場補正 (プライム): 91 × 1.0 = 91点
```

**RSIスコア**:
```
RSI = 35
→ 30〜50の範囲なので線形補間
→ score ≈ 75点
```

**価格位置スコア**:
```
価格位置 = 25%
→ 20%〜40%の範囲なので線形補間
→ baseScore ≈ 87点
→ 市場補正 (プライム): 87 × 1.0 = 87点
```

#### 総合スコア
```
totalScore = (
  96 × 0.28 +   // PER: 26.88
  91 × 0.22 +   // PBR: 20.02
  75 × 0.33 +   // RSI: 24.75
  87 × 0.17     // 価格位置: 14.79
) / 100

= 86.44 / 100
= 0.8644

→ スコア 0.86（最高評価）
```

---

## 🔄 実装フロー

### データフロー

```
1. getLatestIndicators (クエリサービス)
   - DBから最新の指標データ取得
   - 銘柄情報と業種平均をJOINして取得
   ↓
2. filterProMarket (ドメインサービス)
   - PROマーケット銘柄を除外
   ↓
3. filterTrapStocks (ドメインサービス)
   - 罠銘柄（財務健全性が低い銘柄）を除外
   ↓
4. calculateScores (ドメインサービス)
   - 各銘柄のスコアを計算
   - configの閾値と重みを使用
   - 市場別補正を適用
   ↓
5. rankByScore (ドメインサービス)
   - スコア順にソート
   - 上位N件を抽出
   ↓
6. DTOにパースして返却
```

### 週次ジョブ（中期スコア）

1. Inngestジョブが毎週月曜8:00 JSTに起動
2. 中期指標データを取得（過去26週分）
3. フィルタリング → スコア計算 → ランキング
4. 上位10銘柄をLINE通知

### 月次ジョブ（長期スコア）

1. Inngestジョブが毎月1日〜3日の最初の平日8:00 JSTに起動
2. 長期指標データを取得（過去52週分）
3. フィルタリング → スコア計算 → ランキング
4. 上位10銘柄をLINE通知

---

## 🔧 設定ファイル

スコアリングの重みや閾値は `scoringConfig.ts` で一元管理されており、調整が容易です。

### 中期設定 (MID_TERM_CONFIG)
```typescript
{
  perWeight: 28,
  pbrWeight: 22,
  rsiWeight: 33,
  priceRangeWeight: 17,

  perThresholds: { excellent: 70, good: 100 },
  pbrThresholds: { excellent: 70, good: 100 },
  rsiThresholds: { oversold: 30, neutral: 50 },
  priceRangeThresholds: { bottom: 20, low: 40 },

  marketAdjustments: {
    prime: { per: 1.0, pbr: 1.0, priceRange: 1.0 },
    standard: { per: 1.05, pbr: 1.0, priceRange: 1.05 },
    growth: { per: 1.2, pbr: 0.8, priceRange: 0.95 }, // グロースはPER重視、PBR軽視
    other: { per: 1.0, pbr: 1.0, priceRange: 1.0 },
  }
}
```

### 長期設定 (LONG_TERM_CONFIG)
```typescript
{
  perWeight: 35,
  pbrWeight: 30,
  rsiWeight: 18,
  priceRangeWeight: 17,

  // 閾値と市場別補正は中期と同じ設定
}
```

---

## 🎯 将来の拡張計画

### TODO: 業種トレンドスコアの実装

現在は未実装ですが、将来的に以下の機能を追加予定:

**概要**: 業種全体のトレンドを評価し、スコアに加算

**データソース**: TOPIX業種別指数（例: `^TSEC.T`）

**計算ロジック**:
```typescript
// 業種指数の移動平均を取得
MA13 = 過去13期間の業種指数平均
MA26 = 過去26期間の業種指数平均

// トレンド判定
if (MA13 > MA26) {
  // 業種が上昇トレンド → 加点
} else {
  // 業種が下降/横ばい → 0点
}
```

**メリット**: 「個別銘柄は割安だが業種全体が弱い」銘柄と「個別銘柄が割安で業種も強い」銘柄を区別可能

---

## 📝 変更履歴

### 2025-11-26 (最新)
- **未使用のSCORE_THRESHOLD定数を削除**
  - 現在の実装ではスコア計算後に上位N件取得するため不要
- **グロース市場補正を見直し**: PER 1.1→1.2、PBR 0.9→0.8
  - グロース企業の特性（成長期待重視）により適合
- **価格位置の異常値チェックを追加**: データ不整合を早期検出
  - 現在価格が期間レンジ外の場合は0点+警告ログ出力

### 2025-11-26 (初版)
- スコア計算を10段階から線形スケール（0-100）に変更
- 重みを100%に正規化（中期: 28/22/33/17、長期: 35/30/18/17）
- 市場別補正を小幅調整（±10%以内）に変更
- clamp処理を追加して異常値を防止
- scoringConfigを適切に設計し、閾値を計算ロジックで使用
- PROマーケット除外、罠銘柄除外フィルターを実装
- ドキュメントを最新の実装に合わせて全面改訂
