/**
 * 長期マーケット分析プロンプトの生成
 * 半年〜3年の投資目線での分析
 * 有望マクロタグ・テーマタグの選定も行う
 *
 * TODO: favorableThemes/unfavorableThemes と favorableThemeTags の役割を整理する
 * - favorableThemes: LLMが自由記述した注目テーマ（LINE通知、個別株分析コンテキストで使用中）
 * - favorableThemeTags: 事前定義されたタグIDから選択（スコアリングで使用予定）
 * 現在は併存しているが、将来的に統一するか役割を明確に分けるか検討が必要
 */

import { MACRO_TAGS } from "@/assets/macroTags";
import { STOCK_MARKET_SECTORS } from "@/assets/stockMarketSectors";
import { THEME_TAGS } from "@/assets/themeTags";

/**
 * 長期マーケット分析用のプロンプト構造
 */
export type LongTermMarketAnalysisPrompt = Readonly<{
  /** マスタデータコンテキスト（developerロールで渡す） */
  context: string;
  /** 分析指示（userロールで渡す） */
  instruction: string;
}>;

/**
 * マスタデータコンテキストを生成
 */
const buildMasterDataContext = (): string => {
  const sectorListText = STOCK_MARKET_SECTORS.map((s) => `- ${s.sectorCode}: ${s.sectorName}`).join(
    "\n",
  );

  const macroTagListText = MACRO_TAGS.map((t) => `- ${t.id}: ${t.name} - ${t.description}`).join(
    "\n",
  );

  const themeTagListText = THEME_TAGS.map((t) => `- ${t.id}: ${t.name} - ${t.description}`).join(
    "\n",
  );

  return `# マスタデータ

## TOPIX 33業種コード一覧
セクターの選択には、以下のマスタデータを参照してください。
${sectorListText}

## マクロタグ一覧
マクロタグの選択には、以下のマスタデータを参照してください。
${macroTagListText}

## テーマタグ一覧
テーマタグの選択には、以下のマスタデータを参照してください。
${themeTagListText}`;
};

/**
 * 長期マーケット分析の指示を生成
 */
const buildInstruction = (): string => {
  return `現在の日本株市場における長期（半年〜3年）の投資環境を分析してください。

# 分析期間
長期（半年〜3年）の投資目線で分析してください。

# Web検索の活用（重要）

## 長期分析で重視すべき情報
- 日銀の金融政策の中長期的な方向性
- 産業政策・国策の動向（半導体、防衛、GXなど）
- グローバルな経済構造の変化
- 人口動態・社会構造の変化
- 技術革新の進展状況

## 長期分析で影響され過ぎないこと
- FOMC直後、日銀会合当日などの短期反応
- 単月の経済指標のブレ
- 四半期ごとの企業業績の一時的な増減
- 短期の需給・投機的な動き

## 情報の鮮度ルール
- 6ヶ月以内の情報を優先すること
- 1年以上前の情報は使用禁止（中期経営計画など複数年計画は例外）

## 検索結果の活用ルール
- 公式発表、日経、Bloomberg、Reutersなどを優先
- 検索結果は自分の言葉で要約して使用

# 分析方針（必ず守ること）
- 短期イベント（FOMC直後の反応、日銀会合の当日影響など）に過度に依存しないこと
- **構造的テーマ**を重視すること（産業構造の変化、技術革新、規制変更など）
- **設備投資サイクル**を考慮すること
- **人口動態・地政学的変化**の影響を分析すること
- 持続的な成長ドライバーを持つ分野を特定すること

# 分析項目

## 1. 金利動向分析
以下の観点で分析してください（400文字以内、厳守）：
- 日銀の金融政策の中長期的な方向性
- グローバルな金利環境の構造変化
- 金利正常化が日本企業の収益構造に与える影響
- 金融セクター、不動産セクターへの長期的影響

## 2. 注目セクター（3-5件）
長期（半年〜3年）で注目すべきセクターを3-5件挙げてください。
選定基準：
- 構造的な成長ドライバーを持つセクター
- 設備投資拡大が期待されるセクター
- 人口動態・社会変化の恩恵を受けるセクター
- 国策・産業政策の追い風があるセクター

各セクターについて:
- sectorCode: コンテキストのTOPIX 33業種コードから選択
- sectorName: セクター名
- reason: 注目理由（60文字以内、厳守）

## 3. 注意セクター（2-3件）
長期（半年〜3年）で注意が必要なセクターを2-3件挙げてください。
選定基準：
- 構造的な需要減退が見込まれるセクター
- 技術革新による代替リスクがあるセクター
- 規制強化の影響を受けるセクター

各セクターについて:
- sectorCode: コンテキストのTOPIX 33業種コードから選択
- sectorName: セクター名
- reason: 注意理由（60文字以内、厳守）

## 4. 注目テーマ・事業内容（3-5件）
セクターよりも細かい粒度での注目テーマを3-5件挙げてください。
例: 「生成AI関連」「半導体製造装置」「防衛関連」「再生可能エネルギー」など
選定基準：
- 長期的な市場拡大が見込まれるテーマ
- 日本企業が競争優位を持つ分野
- 政策支援が期待できるテーマ

各テーマについて:
- theme: テーマ名（30文字以内、厳守）
- description: 説明（80文字以内、厳守）

## 5. 注意テーマ・事業内容（2-3件）
長期的に注意が必要なテーマを2-3件挙げてください。
例: 「暗号資産関連」「中国依存度の高い事業」「レガシー技術依存」など

各テーマについて:
- theme: テーマ名（30文字以内、厳守）
- description: 説明（80文字以内、厳守）

## 6. 経済・マーケット総括
長期（半年〜3年）の日本株市場の展望を400文字以内（厳守）で総括してください。
以下の観点を網羅すること：
- 金利・為替の中長期的な方向性
- 日本企業の収益構造の変化見通し
- グローバル経済の構造変化と日本株への影響
- 推奨する長期投資スタンス

## 7. 有望マクロタグ（3-5件）
長期（半年〜3年）の投資期間で有利に働くマクロ経済環境タグを選択してください。
現在のマクロ経済環境を踏まえ、以下のような観点で選択：
- 金利上昇/低下局面でどのタグが有利か
- 円高/円安局面でどのタグが有利か
- インフレ/デフレ局面でどのタグが有利か
- 景気拡大/後退局面でどのタグが有利か

コンテキストのマクロタグ一覧から**3-5件のID**を選択してください。

## 8. 有望テーマタグ（5-8件）
長期（半年〜3年）の投資期間で成長が期待されるテーマ・事業領域タグを選択してください。
構造的な成長ドライバーがあり、持続的な追い風が期待できるテーマを優先してください。
選定基準：
- 産業構造の変化で恩恵を受けるテーマ
- 政策支援が継続するテーマ
- グローバルな成長トレンドに乗るテーマ
- 日本企業が競争力を持つテーマ

コンテキストのテーマタグ一覧から**5-8件のID**を選択してください。

## 9. 不利マクロタグ（2-4件）
長期（半年〜3年）の投資期間で不利に働くマクロ経済環境タグを選択してください。
現在のマクロ経済環境を踏まえ、以下のような観点で選択：
- 金利上昇/低下局面でどのタグが不利か
- 円高/円安局面でどのタグが不利か
- インフレ/デフレ局面でどのタグが不利か
- 景気拡大/後退局面でどのタグが不利か

コンテキストのマクロタグ一覧から**2-4件のID**を選択してください。
**注意**: 有望マクロタグで選択したIDと重複しないこと。

## 10. 不利テーマタグ（3-5件）
長期（半年〜3年）の投資期間で逆風が予想されるテーマ・事業領域タグを選択してください。
構造的な需要減退や競争激化が見込まれるテーマを選択してください。
選定基準：
- 技術革新により代替されるリスクがあるテーマ
- 規制強化の影響を受けるテーマ
- 人口動態の変化で需要減退が見込まれるテーマ
- グローバル競争で日本企業が劣後するテーマ

コンテキストのテーマタグ一覧から**3-5件のID**を選択してください。
**注意**: 有望テーマタグで選択したIDと重複しないこと。

# 出力形式
- 出力はシステムから提供されるレスポンススキーマに厳密に従ってください
- 以下のフィールドを含むJSONオブジェクトを出力してください：
  - periodType: "long_term"
  - interestRateTrend: 金利動向分析（400文字以内）
  - favorableSectors: 注目セクターの配列（reason: 60文字以内）
  - unfavorableSectors: 注意セクターの配列（reason: 60文字以内）
  - favorableThemes: 注目テーマの配列（theme: 30文字以内, description: 80文字以内）
  - unfavorableThemes: 注意テーマの配列（theme: 30文字以内, description: 80文字以内）
  - economicSummary: 経済・マーケット総括（400文字以内）
  - favorableMacroTags: 有望マクロタグIDの配列（3-5件）
  - favorableThemeTags: 有望テーマタグIDの配列（5-8件）
  - unfavorableMacroTags: 不利マクロタグIDの配列（2-4件）
  - unfavorableThemeTags: 不利テーマタグIDの配列（3-5件）

# 出力前の自己検証（必須）

JSON出力を生成した後、出力前に以下を必ず確認し、違反があれば修正してから出力してください。

## 1. 引用・参照・URLのチェック（最優先）
出力テキスト全体をスキャンし、以下が含まれていたら**必ず削除**してから出力：
- URL（http、https、www で始まる文字列、.com .co.jp .html 等を含む文字列）
- 引用マーカー（cite、turn、news、search を含む文字列）
- 出典表記（Sources:、参考:、出典:、[1]、(日経新聞) など）
- 「〜によると」「〜の報道では」という表現

## 2. 文字数チェック
- interestRateTrend: 400字以内か？ → 超過なら要約して短縮
- economicSummary: 400字以内か？ → 超過なら要約して短縮
- reason: 各60字以内か？ → 超過なら簡潔にまとめる
- description: 各80字以内か？ → 超過なら簡潔にまとめる

## 3. 整合性チェック
- セクターコード、マクロタグID、テーマタグIDがマスタデータと一致しているか？
- 注目セクターと注意セクターに重複がないか？
- 有望タグと不利タグに重複がないか？

※ 検証で問題が見つかった場合は、必ず修正してから出力すること。
※ 引用マーカーが残っている出力は無効として扱われます。

# 重要な注意事項
- periodTypeは必ず "long_term" を設定してください
- セクターコード、マクロタグID、テーマタグIDはコンテキストのマスタデータから正確に選択してください
- 注目セクターと注意セクターで同じsectorCodeを選ばないこと
- 有望タグと不利タグで同じIDを選ばないこと（マクロタグ、テーマタグそれぞれ）
- 有望タグ、不利タグに関して株価の影響度が少なそうなタグは避けてください
- 各項目の文字数制限を厳守してください`;
};

/**
 * 長期マーケット分析用のLLMプロンプトを生成
 */
export const buildLongTermMarketAnalysisPrompt = (): LongTermMarketAnalysisPrompt => {
  return {
    context: buildMasterDataContext(),
    instruction: buildInstruction(),
  };
};
